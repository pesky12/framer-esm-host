name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (without v prefix)'
        required: true
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: Extract version
        id: extract_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"
          
      - name: Build project
        run: npm run build
        
      - name: Create versioned release
        run: |
          mkdir -p pages
          mkdir -p pages/esmbuild@${{ steps.extract_version.outputs.VERSION }}
          cp -r dist/* pages/esmbuild@${{ steps.extract_version.outputs.VERSION }}/
          # Also copy to root for direct module access
          cp -r dist/* pages/
          
      - name: Create index page
        run: |
          cat > pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Framer ESM Host</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; line-height: 1.6; }
                  h1 { color: #333; }
                  .version { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
                  .code { background: #f8f8f8; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; }
                  a { color: #0066cc; }
              </style>
          </head>
          <body>
              <h1>Framer ESM Host</h1>
              <p>This repository builds components that can be consumed in Framer as ES Modules.</p>
              
              <div class="version">
                  <h3>Latest Version: ${{ steps.extract_version.outputs.VERSION }}</h3>
                  <p>Main Bundle: <span class="code">https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/index.js</span></p>
                  <p>OGL Only: <span class="code">https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/ogl/index.js</span></p>
                  <p>Versioned: <span class="code">https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/esmbuild@${{ steps.extract_version.outputs.VERSION }}/index.js</span></p>
              </div>
              
              <h3>Usage in Framer</h3>
              <p>Add this to your Framer code component:</p>
              <pre><code>// Import all components (React + OGL)
          import { Button, Renderer, Program, Mesh } from "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/index.js"
          
          // Or import ONLY OGL WebGL components (recommended for WebGL work)
          import { Renderer, Program, Mesh, Camera, Vec3 } from "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/ogl/index.js"
          
          // Individual React components
          import { Button } from "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/button/index.js"
          import { Battery } from "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/battery/index.js"
          
          export default Button</code></pre>
              
              <h3>Available Module Paths</h3>
              <ul>
                  <li><a href="./index.js">All Components</a> - React + OGL (~53KB)</li>
                  <li><a href="./ogl/index.js">OGL WebGL Only</a> - No React dependencies (~53KB)</li>
                  <li><a href="./button/index.js">Button Component</a> - Individual React component</li>
                  <li><a href="./battery/index.js">Battery Component</a> - Individual React component</li>
                  <li><a href="./esmbuild@${{ steps.extract_version.outputs.VERSION }}/index.js">Versioned Bundle</a> - Stable versioned URL</li>
              </ul>
              
              <h3>Component Types</h3>
              <h4>React Components</h4>
              <ul>
                  <li><strong>Button</strong> - Customizable button component</li>
                  <li><strong>MotionButton</strong> - Animated button using Framer Motion</li>
                  <li><strong>Battery</strong> - Battery indicator component</li>
              </ul>
              
              <h4>OGL WebGL Components</h4>
              <ul>
                  <li><strong>Renderer</strong> - WebGL renderer for creating graphics</li>
                  <li><strong>Program</strong> - Shader program management</li>
                  <li><strong>Mesh</strong> - 3D mesh combining geometry and shaders</li>
                  <li><strong>Triangle, Geometry</strong> - 3D geometry primitives</li>
                  <li><strong>Camera</strong> - Perspective and orthographic cameras</li>
                  <li><strong>Vec3, Mat4, Color</strong> - Math and utility classes</li>
                  <li>And many more WebGL utilities!</li>
              </ul>
              
              <p><a href="https://github.com/${{ github.repository }}">View on GitHub</a></p>
          </body>
          </html>
          EOF

      - name: List built files
        run: |
          echo "Built files in pages directory:"
          find pages -type f -name "*.js" -o -name "*.html" | head -20

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './pages'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4